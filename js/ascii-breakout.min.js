(function(){var C=[].indexOf||function(z){for(var u=0,p=this.length;u<p;u++)if(u in this&&this[u]===z)return u;return-1};$(document).ready(function(){var z,u,p,D,K,L,n,l,M,E,N,O,P,a,F,m,x,Q,R,A,G,t,y,v,S,T,U,H,V,W,X,I,B,Y,J,Z,r,w;r=function(a){return 0<a?1:0>a?-1:0};Z=function(){a.state="win";$(".title").html("You won, Congratulations!");$(".splash").show();J();return $("#ascii-submit").show()};B=function(){v("unpause");$(".splash").hide();return a.state="running"};X=function(){w();a.state="over";
a.ball_locked=!0;$(".title").html("Game Over!");$(".splash").show();$("#ascii-submit").show();return J()};I=function(){v("pause");a.state="paused";$(".title").html("Game Paused");$(".splash").show();$("#ascii-submit").hide();$(".twitter-share").hide();return $(".social-links").hide()};Y=function(){a.state="splash";$("#msg-flash").hide();$(".title").html("ascii breakout");$(".splash").show();$("#ascii-submit").show();return $(".twitter-share").hide()};y=function(b,d,f){$("#msg-flash").html(b);d&&(a.flash=
!0);return $("#msg-flash").fadeIn(f,function(){a.flash=!1;return $("#msg-flash").fadeOut("slow",function(){})})};J=function(){var b;b=encodeURIComponent("I scored "+a.points+" points on http://ascii-breakout.com");$(".twitter-share").html('<a target="_blank"  href="https://twitter.com/home?status='+b+'">Share your score with a link to this game on twitter!"</a>');return $(".twitter-share").show()};W=function(){a.points=m.points;$("td.points").html(a.points)};u=function(b){a.points+=b*a.bonus;$("td.points").html(a.points)};
V=function(){a.lives=m.lives;$("td.lives").html(a.lives)};U=function(b){a.lives-=b;$("td.lives").html(a.lives);return a.lives?(w(),b=1<a.lives?a.lives+" lives remaining":"One life remaining",y(b,!1,"slow"),a.ball_locked=!0):X()};z=function(b){a.bonus+=b;$("td.bonus").html(a.bonus+"x");return $("td.bonuses").html(""+a.bonuses.length)};H=function(){a.bonuses=[];a.paddle=m.paddle;a.ball=m.ball;a.fall_interval=m.fall_interval;a.fall_speed=m.fall_speed;a.brick_bounce=!0;$("td.bonus").html(a.bonus+"x");
return $("td.bonuses").html(""+a.bonuses.length)};$(document).click(function(b){switch(a.state){case "running":a.ball_locked?a.ball_locked=!1:I();break;case "paused":B()}});R=function(b){return a.ascii_colors[b%a.ascii_colors.length]};$(document).keydown(function(b){switch(a.state){case "paused":27===b.keyCode&&B();break;case "running":27===b.keyCode&&I(),32===b.keyCode&&(a.ball_locked=!1)}39===b.keyCode?(a.right_down=!0,a.paddle_dir=1):37===b.keyCode?(a.left_down=!0,a.paddle_dir=-1):83===b.keyCode&&
(a.sound_enabled=!a.sound_enabled,a.sound_enabled?$(".sound-toggle").text("ON"):$(".sound-toggle").text("OFF"));alert(b.keyCode)});$(document).keyup(function(b){39===b.keyCode?(a.right_down=!1,a.right_acc=0,a.paddle_dir=0):37===b.keyCode&&(a.left_down=!1,a.left_acc=0,a.paddle_dir=0)});$(document).bind("touchmove mousemove",function(b){switch(a.state){case "running":if(null!==a.m_timeout&&clearTimeout(a.m_timeout),a.m_timeout=setTimeout(function(){a.m_timeout=null;return a.paddle_dir=0},50),b=b.originalEvent.touches?
b.originalEvent.touches[0].pageX:b.pageX,b>a.mouse_min_x&&b<a.mouse_max_x)return b-a.mouse_min_x<a.paddle_x?a.paddle_dir=-1:b-a.mouse_min_x>a.paddle_x&&(a.paddle_dir=1),a.l_paddle_x=a.paddle_x,a.paddle_x=b-a.mouse_min_x}});$("input[name=str]").on("input",function(a){x($("input[name=str]").val())});$("#ascii-submit").submit(function(b){0<$("input[name=str]").val().length&&(a.bonus=m.bonus,H(),V(),W(),x($("input[name=str]").val()),B());b.preventDefault()});N=function(b,d){var f,c,e,g,h,k;l.save();l.translate(a.l_x+
a.ball.w_h,a.l_y+a.ball.h_h);l.rotate(a.l_ball_angle);l.clearRect(-a.ball.w_h-a.p_char_w,-a.ball.h_h-a.p_font_size,a.ball.w+3*a.p_char_w,a.ball.h+3*a.p_font_size);l.restore();l.fillStyle=a.paddle_color;l.save();l.translate(b+a.ball.w_h,d+a.ball.h_h);l.rotate(a.ball_angle);e=h=0;for(k=a.ball.rows-1;0<=k?h<=k:h>=k;e=0<=k?++h:--h)g=function(){var b,c,d;d=[];b=1;for(c=a.ball.cols;1<=c?b<=c:b>=c;1<=c?++b:--b)d.push("O");return d}().join(""),l.fillText(g,-a.ball.w_h,-a.ball.h_h+e*a.p_font_size);l.restore();
0===a.loop_cnt%a.ball_spin_speed&&(a.l_ball_angle=a.ball_angle,a.ball_angle+=a.ball_spin*a.ball_da,h=[a.x,a.y],k=[a.x+a.ball.w,a.y],g=[a.x+a.ball.w,a.y+a.ball.h],e=[a.x,a.y+a.ball.h],f=A(h,k,g,e),g=Math.floor(Math.max.apply(null,function(){var a,b,d;d=[];a=0;for(b=f.length;a<b;a++)c=f[a],d.push(c[1]);return d}())),k=Math.ceil(Math.min.apply(null,function(){var a,b,d;d=[];a=0;for(b=f.length;a<b;a++)c=f[a],d.push(c[1]);return d}())),e=Math.ceil(Math.max.apply(null,function(){var a,b,d;d=[];a=0;for(b=
f.length;a<b;a++)c=f[a],d.push(c[0]);return d}())),h=Math.floor(Math.min.apply(null,function(){var a,b,d;d=[];a=0;for(b=f.length;a<b;a++)c=f[a],d.push(c[0]);return d}())),0>h&&(a.x-=h),e>a.w&&(a.x-=e-a.w),0>k&&(a.y-=k),g>a.h-a.paddle.h&&(a.y-=g-(a.h-a.paddle.h)))};t=function(a,d,f,c){if(0>d)return Math.max(c,a+d);if(0<=d)return Math.min(f,a+d)};O=function(b){var d;l.clearRect(0,a.h-a.paddle.h-1,a.w,a.paddle.h);l.fillStyle=a.paddle_color;var f,c;c=[];d=1;for(f=a.paddle.cols-2;1<=f?d<=f:d>=f;1<=f?++d:
--d)c.push("O");d="["+c.join("")+"]";l.fillText(d,b,a.h-a.paddle.h)};Figlet.loadFont=function(a,d){return $.ajax({url:"fonts/"+a+".flf",datatype:"text",success:d})};x=function(b){Figlet.parsePhrase(b,a.figlet_font,function(d,f,c){var e;a.space_w=c;e=L(d,f);a.board_disp=K(d,e,f,c);c=encodeURIComponent(b);d=encodeURIComponent(a.figlet_font);f=encodeURIComponent(a.font_size);0<b.length?$(".share-link").html('Link to this game! <a href="#'+c+"/"+d+"/"+f+'">'+b.replace(/\W/g,"-")+"</a>"):$(".share-link").html("");
return w()})};L=function(b,d){var f,c,e,g,h,k;e=[];g=0;c=!1;if(!b||0===b.length)return[];k=b[0];f=h=0;for(k=k.length;h<k;f=++h)g+=a.char_w,g<a.w?0<=C.call(d,f)&&(c=f):g>a.w&&(c?(e.push(c),g=0+a.char_w*(f-c),c=!1):(e.push(f),g=0));0===e.length?e.push(b[0].length):e[e.length-1]<b[0].length&&e.push(b[0].length);return e};S=function(b,d,f,c){return b>f+a.char_w||b<f||d>c+a.font_size||d<c?!1:!0};D=function(b,d,f){var c,e,g,h,k,q,n,l,m,p;k=a.x;q=a.y;n=1;for(m=a.ball.rows;1<=m?n<=m:n>=m;1<=m?++n:--n){l=
1;for(p=a.ball.cols;1<=p?l<=p:l>=p;1<=p?++l:--l){h=[k,q];e=[k+a.p_char_w,q];g=[k+a.p_char_w,q+a.p_font_size];c=[k,q+a.p_font_size];c=A(h,e,g,c);e=g=0;for(h=c.length;g<h;e=++g)if(e=c[e],S(e[0]+a.dx,e[1]+a.dy,b,d))return u(1),f?f([e[0],e[1]],b,d):[e[0],e[1]];k+=a.p_char_w}k=a.x;q+=a.p_font_size}return!1};G=function(b,d,f){if(!a.brick_bounce)return!0;b=Math.atan2(b[1]-(f+a.font_size_h),b[0]-(d+a.char_w_h));switch(!1){case !(b<=Math.PI/4&&b>-Math.PI/4):0>=a.dx&&(a.dx=-a.dx);break;case !(b<=-Math.PI/4&&
b>-3*Math.PI/4):0<=a.dy&&(a.dy=-a.dy);break;case !(b<=-3*Math.PI/4&&b>=-Math.PI||b<=Math.PI&&b>=3*Math.PI/4):0<=a.dx&&(a.dx=-a.dx);break;case !(b<=3*Math.PI/4&&b>Math.PI/4):0>=a.dy&&(a.dy=-a.dy)}return!0};K=function(a,d,f,c){var e,g,h,k,q,n,l,m,p,r,t;e=[];m=l=h=k=0;for(r=d.length;m<r;m++){g=d[m];n=p=0;for(t=a.length;p<t;n=++p)q=a[n],0<=C.call(f,g)&&0!==h&&(l=c),q=q.slice(h+l,g),e[n+k*a.length]=q;h=g;k+=1}return e};T=function(){var b,d,f,c,e,g,h,k,q,l,m,p,r,t,u;q=0;f=!0;c=l=k=null;u=a.board_disp;g=
m=0;for(r=u.length;m<r;g=++m){e=u[g];h=a.w_h-Math.round(e.length*a.char_w/2);d=p=0;for(t=e.length;p<t;d=++p)b=e[d]," "!==b&&(f=!1,b=D(h,q))&&(c=b,k=h,l=q,a.board_disp[g][d]=" ",n.clearRect(h,q,a.char_w,a.font_size)),h+=a.char_w;q+=a.font_size}c&&(v("hit"),G(c,k,l));return f};E=function(){var b;v("upgrade");for(5<=a.bonuses.length&&H();!(b=Math.ceil(5*Math.random()),0>C.call(a.bonuses,b)););a.bonuses.push(b);switch(b){case 1:y("Small Paddle +10!",!0,"fast");z(10);a.paddle.cols=5;break;case 2:y("Double Paddle +2!");
z(2);a.paddle.cols*=2;break;case 3:y("Small ball",!0,"fast");z(20);a.ball.cols=1;a.ball.rows=1;break;case 4:y("More falling bricks!",!0,"fast");a.fall_interval=100;break;case 5:y("Super ball!!",!0,"fast"),a.brick_bounce=!1,a.ball.cols=5,a.ball.rows=5}return w()};P=function(){var b,d,f,c,e,g,h;b=function(b,d){n.save();n.translate(c.x+a.char_w_h,b+a.font_size_h);n.rotate(d);n.clearRect(-a.char_w_h-a.char_w,-a.font_size_h-a.font_size,3*a.char_w,3*a.font_size);return n.restore()};e=a.block_rotations.filter(function(a){return!0===
a.d});f=0;for(d=e.length;f<d;f++)c=e[f],c.y+a.font_size>a.h-a.paddle.h&&c.x+a.char_w>a.paddle_x&&c.x<a.paddle_x+a.paddle.w?(c.d=!1,E(),w()):D(c.x,c.y,G)?(c.d=!1,E(),w()):"running"===a.state&&0===a.loop_cnt%c.s&&(c.l_y&&b(c.l_y,c.l_r),c.c||(console.log("UNDEFINED"),console.log(a.block_rotations)),n.save(),n.translate(c.x+a.char_w_h,c.y+a.font_size_h),n.rotate(c.r),n.fillText(c.c,-a.char_w_h,-a.font_size_h),n.restore(),c.l_y=c.y,c.y+=a.font_size,c.l_r=c.r,c.r+=Math.PI/4,c.y>a.h&&(c.d=!1,b(c.l_y,c.l_r)));
if("running"===a.state&&(b=a.board_disp[a.l_char_row_index],0===a.loop_cnt%a.fall_interval&&b)){f=[];d=g=0;for(h=b.length;g<h;d=++g)e=b[d]," "!==e&&f.push(d);0!==f.length&&(d=f[Math.floor(Math.random()*f.length)],e=a.w_h-Math.round(b.length*a.char_w/2),b[d]||console.log("Adding undefined value! "+f+" "+d),a.block_rotations.push({x:e+a.char_w*d,y:a.l_char_row_index*a.font_size+a.font_size,l_y:null,l_r:null,r:0,rs:Math.floor(10*Math.random()+3),c:b[d],s:a.fall_speed(),d:!0}),b[d]=" ",n.clearRect(e+
a.char_w*d,a.l_char_row_index*a.font_size,a.char_w,a.font_size))}};M=function(){var b,d,f,c,e,g,h,k,q;e=0;k=a.board_disp;q=[];d=g=0;for(h=k.length;g<h;d=++g)b=k[d],c=a.w_h-Math.round(b.length*a.char_w/2),f=R(d),b.some(function(a){return" "!==a})&&(a.l_char_row_index=d),n.fillStyle=f,n.fillText(b.join(""),c,e),q.push(e+=a.font_size);return q};A=function(b,d,f,c){var e,g,h,k;if(0===Math.round(100*a.ball_angle)%Math.round(100*Math.PI))return[b,d,f,c];h=a.x+a.ball.w_h;k=a.y+a.ball.h_h;e=Math.cos(a.ball_angle);
g=Math.sin(a.ball_angle);return[[h+(b[0]-h)*e+(b[1]-k)*g,k-(b[0]-h)*g+(b[1]-k)*e],[h+(d[0]-h)*e+(d[1]-k)*g,k-(d[0]-h)*g+(d[1]-k)*e],[h+(f[0]-h)*e+(f[1]-k)*g,k-(f[0]-h)*g+(f[1]-k)*e],[h+(c[0]-h)*e+(c[1]-k)*g,k-(c[0]-h)*g+(c[1]-k)*e]]};Q=function(){var b,d;b=A([a.x,a.y],[a.x+a.ball.w,a.y],[a.x+a.ball.w,a.y+a.ball.h],[a.x,a.y+a.ball.h]);return Math.max.apply(null,function(){var a,c,e;e=[];a=0;for(c=b.length;a<c;a++)d=b[a],e.push(d[1]);return e}())-Math.min.apply(null,function(){var a,c,e;e=[];a=0;for(c=
b.length;a<c;a++)d=b[a],e.push(d[1]);return e}())};F=function(){var b,d,f,c,e,g;if("running"===a.state){(f=T())&&0<a.board_disp.length&&Z();if(a.flash)return;a.ball_locked&&(a.l_x=a.x,a.l_y=a.y,a.ball_angle=m.ball_angle,a.ball_spin=m.ball_spin,a.dx=m.dx,a.dy=m.dy,a.x=a.paddle_x+a.paddle.w_h-a.ball.w_h,a.y=a.h-a.paddle.h-a.ball.h-(Q()/2-a.ball.h_h));0===a.l_char_row_index||a.ball_locked||P();N(a.x,a.y);a.right_down?a.paddle_x+a.paddle.w<a.w&&(a.l_paddle_x=a.paddle_x,a.paddle_x+=Math.floor(5+a.right_acc),
a.right_acc+=p.acc_rate):a.left_down&&0<a.paddle_x&&(a.paddle_x-=Math.floor(5+a.left_acc),a.left_acc+=p.acc_rate);O(a.paddle_x);e=[a.x,a.y];g=[a.x+a.ball.w,a.y];c=[a.x+a.ball.w,a.y+a.ball.h];f=[a.x,a.y+a.ball.h];b=A(e,g,c,f);c=Math.floor(Math.max.apply(null,function(){var a,c,e;e=[];a=0;for(c=b.length;a<c;a++)d=b[a],e.push(d[1]);return e}()));g=Math.ceil(Math.min.apply(null,function(){var a,c,e;e=[];a=0;for(c=b.length;a<c;a++)d=b[a],e.push(d[1]);return e}()));f=Math.ceil(Math.max.apply(null,function(){var a,
c,e;e=[];a=0;for(c=b.length;a<c;a++)d=b[a],e.push(d[0]);return e}()));e=Math.floor(Math.min.apply(null,function(){var a,c,e;e=[];a=0;for(c=b.length;a<c;a++)d=b[a],e.push(d[0]);return e}()));f+a.dx>a.w&&(v("bounce"),a.ball_spin&&r(a.dy)!==r(a.ball_spin)||(a.dy=t(a.dy,2*-a.ball_spin,a.max_dy,-a.max_dy),a.ball_spin=t(a.ball_spin,-a.dy,a.ball_max_spin,-a.ball_max_spin)),a.dx=-a.dx);0>e+a.dx&&(v("bounce"),a.ball_spin&&r(a.dy)===r(a.ball_spin)||(a.dy=t(a.dy,2*a.ball_spin,a.max_dy,-a.max_dy),a.ball_spin=
t(a.ball_spin,a.dy,a.ball_max_spin,-a.ball_max_spin)),a.dy=r(a.dy)*Math.max(Math.abs(a.dy),Math.abs(m.dy)),a.dx=-a.dx);0>g+a.dy?(v("bounce"),a.ball_spin&&r(a.dx)!==r(a.ball_spin)||(a.dx=t(a.dx,2*-a.ball_spin,a.max_dx,-a.max_dx),a.ball_spin=t(a.ball_spin,-a.dx,a.ball_max_spin,-a.ball_max_spin)),a.dy=r(a.dy)*Math.max(Math.abs(a.dy),Math.abs(m.dy)),a.dy=-a.dy):c+a.dy>a.h-a.paddle.h&&(f>a.paddle_x-a.char_w&&e<a.paddle_x+a.paddle.w+a.char_w?(v("paddle"),a.ball_spin&&r(a.dx)===r(a.ball_spin)||(a.dx=t(a.dx,
2*a.ball_spin,a.max_dx,-a.max_dx),a.ball_spin=t(a.ball_spin,a.dx,a.ball_max_spin,-a.ball_max_spin)),a.dx=t(a.dx,2*-a.paddle_dir,a.max_dx,-a.max_dx),a.ball_spin=t(a.ball_spin,-a.paddle_dir,a.ball_max_spin,-a.ball_max_spin),a.x+a.ball.w<a.paddle_x+a.p_char_w&&(a.dx=-a.max_dx,a.ball_spin=-a.ball_max_spin),a.x>a.paddle_x+a.paddle.w-a.p_char_w&&(a.dx=a.max_dx,a.ball_spin=a.ball_max_spin),a.dy=-a.dy,a.dy=r(a.dy)*Math.max(Math.abs(a.dy),Math.abs(m.dy))):(v("death"),"running"===a.state&&U(1),a.dy=-a.dy));
a.ball_locked||(a.l_x=a.x,a.l_y=a.y,a.x+=a.dx,a.y+=a.dy)}a.loop_cnt+=1};m={dx:0,dy:-6,max_dx:6,max_dy:8,x:-1E3,y:-1E3,l_x:-1,right_down:!1,left_down:!1,right_acc:0,left_acc:0,state:"splash",paddle_color:"white",board_disp:[],space_w:0,ball:{cols:2,rows:2,w:0,h:0},paddle:{cols:9,rows:1,w:0,h:10},width:0,height:0,mouse_min_x:0,mouse_max_x:0,ascii_colors:["#c84848","#c66c3a","#b47a30","#a2a22a","#48a048"],figlet_font:"standard",font_size:9,p_font_size:9,ball_locked:!0,ball_spin:0,ball_angle:0,l_ball_angle:0,
ball_da:Math.PI/16,ball_spin_speed:2,ball_max_spin:1,l_char_row_index:0,loop_cnt:0,block_rotations:[],fall_interval:200,fall_speed:function(){return Math.floor(10*Math.random()+a.font_size/3)},bonuses:[],bonus:1,points:0,lives:3,flash:!1,brick_bounce:!0,paddle_x:void 0,paddle_dir:0,m_timeout:null,sound_enabled:!0};w=function(){l.clearRect(0,0,a.w,a.h);n.clearRect(0,0,a.w,a.h);$("#game-canvas")[0].width=p.max_w;$("#game-canvas")[0].height=p.max_h;a.w=$("#game-canvas").width();a.w_h=Math.ceil(a.w/2);
a.h=$("#game-canvas").height();a.h_h=Math.ceil(a.h/2);$("#brick-canvas")[0].width=a.w;$("#brick-canvas")[0].height=a.h;a.mouse_min_x=$("#game-canvas").offset().left;a.mouse_max_x=a.mouse_min_x+a.w-a.paddle.w;n.textBaseline="top";l.textBaseline="top";n.font=a.font_size+"px "+p.font_name;l.font=a.p_font_size+"px "+p.font_name;a.char_w=n.measureText("]").width;a.p_char_w=l.measureText("]").width;a.char_w_h=Math.round(a.char_w/2);a.p_char_w_h=Math.round(a.p_char_w/2);a.font_size_h=Math.round(a.font_size/
2);a.p_font_size_h=Math.round(a.p_font_size/2);a.ball.w=a.ball.cols*a.p_char_w;a.ball.w_h=Math.round(a.ball.w/2);a.ball.h=a.ball.rows*a.p_font_size;a.ball.h_h=Math.round(a.ball.h/2);a.paddle.w=a.paddle.cols*a.p_char_w;a.paddle.w_h=Math.round(a.paddle.w/2);a.paddle.h=a.paddle.rows*a.p_font_size;a.paddle.h_h=Math.round(a.paddle.h/2);a.paddle_x||(a.l_paddle_x=a.paddle_x,a.paddle_x=a.w_h-a.paddle.w_h);return M()};l=$("#game-canvas")[0].getContext("2d");n=$("#brick-canvas")[0].getContext("2d");a=$.extend(!0,
{},m);a.sound=new Howl({urls:["../sounds/mygameaudio.ogg","../sounds/mygameaudio.m4a","../sounds/mygameaudio.mp3","../sounds/mygameaudio.ac3"],sprite:{bounce:[0,636.054421768707],death:[2E3,597.1655328798184],hit:[4E3,33.922902494331],paddle:[6E3,81.541950113379],pause:[8E3,439.818594104308],unpause:[1E4,439.818594104308],upgrade:[12E3,297.142857142857]}});v=function(b){a.sound_enabled&&a.sound.play(b)};p=$.extend(!0,{},{font_name:"pressStart",default_str:"ASCII BREAKOUT Type whatever you want and play!",
default_font:"standard",acc_rate:.5,max_w:800,max_h:600});w();$.ajax({url:"/fonts.json",datatype:"json",success:function(b){$("#font-name").attr("range",1);$("#font-name").attr("min",1);$("#font-name").attr("max",b.length);$("#font-name").attr("value",b.indexOf(m.figlet_font)+1);return $("#font-name").rangeslider({polyfill:!1,onSlide:function(d,f){if(f)return $("div.font-disp").html("Slide to change the font and size - "+b[f-1]),a.figlet_font=b[f-1],x($("input[name=str]").val())}})}});$("#font-size").rangeslider({polyfill:!1,
onSlide:function(b,d){if(d)return a.font_size=+d,$("#js-rangeslider-0 .rangeslider__handle").html("<div style='overflow: hidden;'>"+d+"</div>"),x($("input[name=str]").val())}});routie(":str?/:font?/:size?",function(b,d,f){var c,e,g;b?(b=decodeURIComponent(b),$("input[name=str]").val(b),d&&(a.figlet_font=decodeURIComponent(d),f&&(a.font_size=+decodeURIComponent(f))),x(b),B()):($("input[name=str]").val(p.default_str),a.figlet_font=p.default_font,x(p.default_str),Y());c=window.requestAnimationFrame||
window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;return null!==c?(e=$("#game-canvas").get(0),g=function(){F();return c(g,e)},c(g,e)):setInterval(F,1E3/60)})})}).call(this);
